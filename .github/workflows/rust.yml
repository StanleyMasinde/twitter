name: Build and test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: linux-x86_64

          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04-arm
            name: linux-arm

          - target: aarch64-apple-darwin
            os: macos-latest
            name: darwin-aarch64

          - target: x86_64-apple-darwin
            os: macos-15-intel
            name: darwin-x86_64

          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: windows-x86_64
            vcpkg_triplet: x64-windows-static-md

          - target: aarch64-pc-windows-msvc
            os: windows-11-arm
            name: windows-arm
            vcpkg_triplet: arm64-windows-static-md
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    - name: Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.8.0
    - name: Install native deps via vcpkg (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
        if (-not $vcpkgRoot) {
          $vcpkgRoot = "C:\vcpkg"
        }
        $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
        if (-not (Test-Path $vcpkgExe)) {
          throw "vcpkg.exe not found at $vcpkgExe"
        }

        & $vcpkgExe install "sqlite3:${{ matrix.vcpkg_triplet }}" "curl:${{ matrix.vcpkg_triplet }}"
        if ($LASTEXITCODE -ne 0) {
          throw "Failed to install sqlite3/curl with vcpkg."
        }

        "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
        "VCPKGRS_TRIPLET=${{ matrix.vcpkg_triplet }}" >> $env:GITHUB_ENV
    - name: Build
      run: cargo build --locked --target "${{ matrix.target }}"

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - uses: actions/checkout@v4
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.8.0
    - name: Run tests
      run: cargo test
